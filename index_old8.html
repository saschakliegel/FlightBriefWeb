<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FlightBrief Web (Editable)</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    nav { display:flex; background:#333; }
    nav button {
      flex:1; padding:1em; border:none;
      color:#fff; background:#333; cursor:pointer;
    }
    nav button.active { background:#555; }
    section { padding:1em; }

    /* Legend buttons */
    #legend {
      display:flex;
      gap:.5em;
      margin-bottom:1em;
      flex-wrap: wrap;
    }
    .legend-btn {
      border:none;
      padding:.5em 1em;
      color:#fff;
      cursor:pointer;
      font-weight:bold;
      border-radius:4px;
    }

    .card {
      margin-bottom:1em;
      padding:.75em;
      border-radius:4px;
      position:relative;
    }
    .card .edit-btn {
      position:absolute;
      top:.5em; right:.5em;
      font-size:.9em; cursor:pointer;
    }

    /* exact colours from the screenshot/legend */
    .airport.cat-D  { background:#2E7D3233; }  /* green @20% */
    .airport.cat-A1 { background:#76FF0333; }  /* bright lime @20% */
    .airport.cat-A2 { background:#FFEB0033; }  /* yellow @20% */
    .airport.cat-CA { background:#FF8F0033; }  /* orange @20% */
    .airport.cat-EA { background:#F4433633; }  /* red @20% */

    .border { background:rgba(0,0,128,0.1); }

    details { margin:0.5em 0; }
    input, textarea { width:100%; box-sizing:border-box; margin:.25em 0; }
    .actions { text-align:right; margin-top:.5em; }
    .actions button { margin-left:.5em; }
  </style>
</head>
<body>

  <nav>
    <button id="airports-tab" class="active">Airports</button>
    <button id="borders-tab">Borders</button>
  </nav>

  <!-- AIRPORTS -->
  <section id="airports-section">
    <h2>Airports</h2>

    <!-- interactive legend -->
    <div id="legend">
      <button class="legend-btn" data-code="D"  style="background:#2E7D32">D</button>
      <button class="legend-btn" data-code="A1" style="background:#76FF03">A1</button>
      <button class="legend-btn" data-code="A2" style="background:#FFEB00">A2</button>
      <button class="legend-btn" data-code="CA" style="background:#FF8F00">CA</button>
      <button class="legend-btn" data-code="EA" style="background:#F44336">EA</button>
    </div>

    <div id="airports-container">Loading…</div>
  </section>

  <!-- BORDERS -->
  <section id="borders-section" style="display:none">
    <h2>Borders</h2>
    <div id="borders-container">Loading…</div>
  </section>

  <script>
    // ---- Definitions for each code ----
    const DEFINITIONS = {
      D: `**Destination Aerodrome (D):** A destination is an aerodrome served by an Emirates scheduled flight. It must be designated as being available for such use in the Emirates Operations Specifications.\n\n**Note 1:** D/A1/A2/CA are considered ‘adequate’ aerodromes.`,
      A1: `**Fully Capable Alternate (A1):** An alternate aerodrome which has all ground-handling capabilities (as approved and accepted by EK Aerodrome Services) and limited engineering capabilities with regard to approved certifying staff (as approved and accepted by Engineering). Captain release or one-off engineering is required.\n\n**Note 1:** D/A1/A2/CA are considered ‘adequate’ aerodromes.`,
      A2: `**Fuel & Go / Planning Alternate (A2):** An alternate aerodrome which has limited ground/engineering (parking stands, Customs/Immigration, etc.), but still allows refuel & redispatch with passengers/cargo onboard.\n\n**Note 1:** D/A1/A2/CA are considered ‘adequate’ aerodromes.`,
      CA: `**Critical Aerodrome (CA):** A critical aerodrome is an aerodrome to which diversion can be accomplished primarily in support of ETOPS operations and drift-down/depressurisation strategies.\n\n**Note 1:** D/A1/A2/CA are considered ‘adequate’ aerodromes.\n**Note 2:** Medical Diversion to CAs is not recommended due to the limited logistical support for flight recovery; use at Commander’s discretion.`,
      EA: `**Emergency Aerodrome (EA):** Aerodromes not meeting any other classification, listed only for rare, dire emergencies where coverage is sparse.`
    };

    // Tab switching
    document.getElementById('airports-tab').onclick = ()=> toggleTab('airports');
    document.getElementById('borders-tab').onclick  = ()=> toggleTab('borders');
    function toggleTab(tab) {
      document.getElementById('airports-section').style.display = tab==='airports'? '':'none';
      document.getElementById('borders-section').style.display  = tab==='borders'?  '':'none';
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById(tab+'-tab').classList.add('active');
    }

    // Legend clicks → show definition
    document.getElementById('legend')
      .addEventListener('click', e=>{
        if(!e.target.matches('.legend-btn')) return;
        const code = e.target.dataset.code;
        alert(DEFINITIONS[code]);
      });

    let airportsData, bordersData;

    // Load both JSONs
    window.addEventListener('DOMContentLoaded', ()=>{
      Promise.all([
        fetch('airports.json').then(r=>r.json()),
        fetch('borders_cleaned.json').then(r=>r.json())
      ]).then(([a,b])=>{
        airportsData = a;
        bordersData  = b;
        renderAirports();
        renderBorders();
      }).catch(console.error);
    });

    // —— Render Airports ——
    function renderAirports(){
      const container = document.getElementById('airports-container');
      container.innerHTML = '';

      airportsData
        .sort((a,b)=> (a.ICAO||'').localeCompare(b.ICAO||''))
        .forEach((a,i)=>{

          // preserve any \n in your JSON fields:
          const runways = (a.Rwy||'–')
            .split(/\r?\n/).map(s=>s.trim()).join('<br/>');
          const approaches = (a.Approach||'–')
            .split(/\r?\n/).map(s=>s.trim()).join('<br/>');
          const cci = (a.CCI||'–')
            .split(/\r?\n/).map(s=>s.trim()).join('<br/>');

          // classification code is before first "/"
          const code = (a['Class/AIRFIELD CAT/RFF']||'D').split('/')[0].trim();

          const card = document.createElement('div');
          card.className = `card airport cat-${code}`;
          card.innerHTML = `
            <span class="edit-btn" data-index="${i}">✎ Edit</span>
            <details open>
              <summary><strong>${a.ICAO} — ${a.Name||''}</strong></summary>
              <div>
                <details><summary>Identifiers</summary>
                  IATA: ${a.IATA||'–'}<br/>
                  Elevation: ${a.Elevation||'–'}
                </details>
                <details><summary>Operational Details</summary>
                  Category/RFF: ${a['Class/AIRFIELD CAT/RFF']||'–'}<br/>
                  <strong>Runways:</strong><br/>${runways}<br/>
                  <strong>Approaches:</strong><br/>${approaches}<br/>
                  <strong>CCI:</strong><br/>${cci}<br/>
                  Ops Hrs: ${a['OPS HRS (ATC/ADMIN)']||'–'}<br/>
                  NOTAM: ${a.NOTAM||'–'}
                </details>
                <details><summary>Weather</summary>
                  METAR: ${a.latestMetar||'–'}<br/>
                  TAF:   ${a.latestTaf||'–'}
                </details>
              </div>
            </details>
          `;
          container.appendChild(card);
        });

      // wire up edits
      document.querySelectorAll('#airports-container .edit-btn')
        .forEach(btn=> btn.onclick = e => editAirport(+e.target.dataset.index));
    }

    function editAirport(idx){
      const a = airportsData[idx];
      const form = document.createElement('form');
      form.innerHTML = `
        <h3>Edit ${a.ICAO}</h3>
        <label>ICAO      <input name="ICAO" value="${a.ICAO}"></label>
        <label>Name      <input name="Name" value="${a.Name||''}"></label>
        <label>IATA      <input name="IATA" value="${a.IATA||''}"></label>
        <label>Elevation <input name="Elevation" value="${a.Elevation||''}"></label>
        <label>Category/RFF <input name="Class/AIRFIELD CAT/RFF" value="${a['Class/AIRFIELD CAT/RFF']||''}"></label>
        <label>Runways   <textarea name="Rwy">${a.Rwy||''}</textarea></label>
        <label>Approach  <textarea name="Approach">${a.Approach||''}</textarea></label>
        <label>CCI       <textarea name="CCI">${a.CCI||''}</textarea></label>
        <label>Ops Hrs   <input name="OPS HRS (ATC/ADMIN)" value="${a['OPS HRS (ATC/ADMIN)']||''}"></label>
        <label>NOTAM     <textarea name="NOTAM">${a.NOTAM||''}</textarea></label>
        <div class="actions">
          <button type="button" id="cancel">Cancel</button>
          <button type="submit">Save</button>
        </div>
      `;
      const card = document.querySelectorAll('#airports-container .card')[idx];
      card.innerHTML = '';
      card.appendChild(form);

      form.querySelector('#cancel').onclick = ()=> renderAirports();
      form.onsubmit = ev=>{
        ev.preventDefault();
        const data = new FormData(form);
        data.forEach((v,k)=> a[k]=v);
        renderAirports();
      };
    }

    // —— Render Borders ——
    function renderBorders(){
      const c = document.getElementById('borders-container');
      c.innerHTML = '';
      bordersData.forEach((b,i)=>{
        const div = document.createElement('div');
        div.className='card border';
        div.innerHTML=`
          <span class="edit-btn" data-index="${i}">✎ Edit</span>
          <details open>
            <summary><strong>${b.waypoint}</strong></summary>
            <div>
              <details><summary>FIR</summary>${b.fir}</details>
              <details>
                <summary>Notes</summary>
                <strong>Requirement:</strong> ${b.notes.requirement}<br/>
                <strong>Frequency:</strong><br/>${b.notes.frequency.replace(/\n/g,'<br/>')}
                ${b.notes.other ? `<br/><strong>Other:</strong><br/>${b.notes.other.replace(/\n/g,'<br/>')}` : ''}
              </details>
            </div>
          </details>`;
        c.appendChild(div);
      });

      document.querySelectorAll('#borders-container .edit-btn')
        .forEach(btn=> btn.onclick = e => editBorder(+e.target.dataset.index));
    }

    function editBorder(idx){
      const b = bordersData[idx];
      const form = document.createElement('form');
      form.innerHTML=`
        <h3>Edit ${b.waypoint}</h3>
        <label>Waypoint    <input name="waypoint" value="${b.waypoint}"></label>
        <label>FIR         <input name="fir"      value="${b.fir}"></label>
        <label>Requirement <textarea name="notes.requirement">${b.notes.requirement}</textarea></label>
        <label>Frequency   <textarea name="notes.frequency">${b.notes.frequency}</textarea></label>
        <label>Other (opt) <textarea name="notes.other">${b.notes.other||''}</textarea></label>
        <div class="actions">
          <button type="button" id="cancel">Cancel</button>
          <button type="submit">Save</button>
        </div>`;
      const card = document.querySelectorAll('#borders-container .card')[idx];
      card.innerHTML=''; card.appendChild(form);

      form.querySelector('#cancel').onclick = ()=> renderBorders();
      form.onsubmit = ev=>{
        ev.preventDefault();
        const data = new FormData(form);
        b.waypoint           = data.get('waypoint');
        b.fir                = data.get('fir');
        b.notes.requirement  = data.get('notes.requirement');
        b.notes.frequency    = data.get('notes.frequency');
        b.notes.other        = data.get('notes.other');
        renderBorders();
      };
    }
  </script>
</body>
</html>
